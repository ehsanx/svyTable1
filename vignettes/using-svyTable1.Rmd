---
title: "Using svyTable1 for Survey-Weighted Summary Tables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using svyTable1 for Survey-Weighted Summary Tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The svyTable1 package provides a straightforward function, svytable1(), to generate descriptive statistics tables ("Table 1") from complex survey data. This vignette demonstrates its use and explains the rationale behind its default "mixed mode" display.

## Understanding the Mixed Mode (A Best Practice)

The svytable1 function defaults to mode = "mixed". This approach is considered a best practice in high-quality survey research for several key reasons rooted in transparency.

When you present a table in mixed mode, you provide two types of information for each categorical variable:

- **The Unweighted N:** This is the actual number of people you interviewed in that category. It tells the reader about the statistical precision of the estimate. A percentage based on 10 people is much less reliable than one based on 1,000 people.
- **The Weighted Percentage (%):** This is an estimate of the proportion of the entire target population that falls into that category, adjusted for the complex survey design (e.g., oversampling of certain groups).

By showing both, you allow your audience to understand the crucial distinction between your sample and the population you are making inferences about. It also reveals the impact of the survey weights—if a group has a small N but a large weighted percentage, it signals that the estimate for that group relies heavily on up-weighting a few individuals, which may affect the stability of the estimate.

## Example: Using NHANES Data (2009–2012)

This section demonstrates how to use svytable1 with the NHANESraw dataset, which contains missing values.

### 1. Data Preparation

```{r}
library(svyTable1)
library(survey)
library(dplyr)
library(NHANES)

# Load the raw NHANES data (2009-2012)
data(NHANESraw)

# Prepare data for adults, keeping NAs
nhanes_adults_with_na <- NHANESraw %>%
  filter(Age >= 20) %>%
  mutate(
    ObeseStatus = factor(ifelse(BMI >= 30, "Obese", "Not Obese"),
                         levels = c("Not Obese", "Obese"))
  )

# Create the survey design object on the data that still contains NAs
adult_design_with_na <- svydesign(
  id = ~SDMVPSU,
  strata = ~SDMVSTRA,
  weights = ~WTMEC2YR,
  nest = TRUE,
  data = nhanes_adults_with_na
)
```

### 2. Generating Tables

#### Example A: Handling Variables with Missing Data

This is the primary use case. We select a range of variables, some of which are known to have missing data (HHIncome, TotChol, SmokeNow). The svytable1 function will process each variable independently, automatically detecting and reporting the extent of missingness for each one.

```{r}
# Define a set of variables, some with expected missing values
vars_with_missing <- c(
  "Age", 
  "Gender", 
  "Race1", 
  "Education",
  "HHIncome", 
  "TotChol",       # Numeric, has NAs
  "SleepHrsNight", # Numeric, has NAs
  "SmokeNow"       # Categorical, has many NAs
)

# Generate the table using the full design object (with NAs)
table_with_missing <- svytable1(
  design = adult_design_with_na, 
  strata_var = "ObeseStatus", 
  table_vars = vars_with_missing
)

# Display the table
knitr::kable(
  table_with_missing, 
  caption = "Table 1: Summarizing Variables with Missing Data"
)
```

Notice that the output table includes a "Missing" column (because ObeseStatus had missing values) and "Missing" rows for variables like Education, HHIncome, TotChol, and SmokeNow.

#### Example B: Summarizing Complete Data

If your analysis requires a dataset with no missing values for a specific set of variables, you can perform a complete-case analysis before creating your table. Here, we use `tidyr::drop_na()` to create a smaller, complete dataset.

```{r}
library(tidyr) # Loaded here as it's specific to this approach

# Define a set of core variables for a complete-case analysis
vars_for_complete_table <- c(
  "Age", 
  "Gender", 
  "Race1",
  "BPSysAve",
  "Pulse",
  "BMI" # Must be included for the strata and to remove its own NAs
)

# Create a new, complete-case data frame
nhanes_adults_complete <- nhanes_adults_with_na %>%
  drop_na(all_of(vars_for_complete_table))

# Create a new design object based on this complete-case data
adult_design_complete <- svydesign(
  id = ~SDMVPSU,
  strata = ~SDMVSTRA,
  weights = ~WTMEC2YR,
  nest = TRUE,
  data = nhanes_adults_complete
)

# Generate the table
# Note: The input data is now complete for this set of variables
table_without_missing <- svytable1(
  design = adult_design_complete, 
  strata_var = "ObeseStatus", 
  table_vars = c("Age", "Gender", "Race1", "BPSysAve", "Pulse")
)

# Display the table
knitr::kable(
  table_without_missing, 
  caption = "Table 2: Summarizing Variables with No Missing Data"
)
```

Notice this table is "clean"—it has no "Missing" rows or columns because the input data was complete for the selected variables.
