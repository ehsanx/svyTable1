% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plotint.R
\name{plotint}
\alias{plotint}
\title{Plot Interaction Effects from a Regression Model}
\usage{
plotint(
  model,
  effect,
  moderator,
  data,
  mod_scale = "sd",
  type = "link",
  show_ci = TRUE,
  bw = FALSE,
  xlab = NULL,
  ylab = NULL,
  legend_title = NULL,
  pval_position = "none"
)
}
\arguments{
\item{model}{A fitted model object (e.g., svycoxph, glm).}

\item{effect}{Character string. The name of the focal predictor (x-axis).}

\item{moderator}{Character string. The name of the moderator variable (lines/groups).}

\item{data}{The original data frame used to fit the model (REQUIRED for survey models).}

\item{mod_scale}{Method for probing a continuous moderator: "sd" (default) or "quantile".}

\item{type}{The scale for the y-axis: "link" (default) or "response".}

\item{show_ci}{Logical. If TRUE (default), plots 95 percent confidence ribbons.}

\item{bw}{Logical. If TRUE, creates a black and white plot.}

\item{xlab}{Character string. Optional custom label for the x-axis.}

\item{ylab}{Character string. Optional custom label for the y-axis.}

\item{legend_title}{Character string. Optional custom title for the legend.}

\item{pval_position}{Position for p-value: "bottom.right", "top.left", etc., or "none".}
}
\value{
Invisibly returns a list containing 'plot_data' and 'p_value_text'.
}
\description{
This function creates a publication-ready plot of a two-way interaction
from various regression models using the emmeans package.
}
\examples{
\donttest{
# =================================================================
# Example 1: Continuous x Continuous (nhanes_mortality)
# =================================================================
library(survival)
library(survey)
library(svyTable1)
library(emmeans)
library(ggplot2)
library(dplyr)

# --- 2. Load & Prepare Data ---
data("nhanes_mortality", package = "svyTable1")

# Filter NAs for the variables used in the model
mort_data <- nhanes_mortality \%>\%
  mutate(
    log_cal = log(cal.total),
    log_carb = log(carbohyd)
  ) \%>\%
  na.omit(subset = c("psu", "strata", "survey_weight", "stime", "status",
                     "log_cal", "log_carb", "age", "sex", "race"))

# --- 3. Fit Model ---
des <- svydesign(id = ~psu, strata = ~strata, weights = ~survey_weight,
                 data = mort_data, nest = TRUE)

# Interaction: age * log_cal
# Adjustments: log_carb, sex, race
model_age_cal <- svycoxph(Surv(stime, status) ~ age * log_cal + log_carb + sex + race,
                          design = des)

# --- 4. CALL THE PLOT FUNCTION ---
# We will plot the effect of Age (x-axis) at different levels of Calories
plot_data <- plotint(
  model = model_age_cal,
  effect = "age",
  moderator = "log_cal",
  data = mort_data,
  mod_scale = "sd", # Use Mean +/- 1 SD for log_cal
  type = "link",
  show_ci = TRUE,
  bw = FALSE,
  pval_position = "bottom.right",
  xlab = "Age (Years)",
  ylab = "Predicted log(Hazard) of Mortality",
  legend_title = "log(Total Calories)"
)

# You can now access the plot data if you want it
# head(plot_data$plot_data)


# =================================================================
# Example 2: Continuous x Continuous (NHANESraw)
# =================================================================
library(NHANES)
library(dplyr)
library(survey)
library(emmeans)
library(ggplot2)

# --- 3. DATA PREPARATION (NHANESraw) ---
data("NHANESraw", package = "NHANES")

# Select relevant variables and filter for adults with complete cases
nhanes_clean <- NHANESraw \%>\%
  filter(Age >= 20) \%>\%
  mutate(
    # Ensure factors are set correctly
    Gender = factor(Gender),
    Race1 = factor(Race1)
  ) \%>\%
  # Keep only the variables we need for this model
  select(
    BPSysAve, Age, BMI, Gender, Race1,
    SDMVPSU, SDMVSTRA, WTMEC2YR
  ) \%>\%
  na.omit() # Listwise deletion for simplicity

# --- 4. DESIGN & MODEL FITTING ---
# Create the survey design object
design_nhanes <- svydesign(
  id = ~SDMVPSU,
  strata = ~SDMVSTRA,
  weights = ~WTMEC2YR,
  nest = TRUE,
  data = nhanes_clean
)

# Fit the model: Interaction of Age * BMI on Geometric Mean of BP
# We use gaussian(link="log") to model Geometric Means
model_bp_interaction <- svyglm(
  BPSysAve ~ Age * BMI + Gender + Race1,
  design = design_nhanes,
  family = gaussian(link = "log")
)

# --- 5. PLOT THE INTERACTION ---

# --- Plot 1: Standard Plot (using quantiles and CIs) ---
# This shows the effect of Age (x-axis) at 10th/50th/90th percentiles of BMI
print(
  plotint(
    model = model_bp_interaction,
    effect = "Age",
    moderator = "BMI",
    data = nhanes_clean,
    mod_scale = "quantile",       # Use 10th/50th/90th percentiles for BMI
    type = "response",          # Plot the Geometric Mean (back-transform from log)
    show_ci = TRUE,
    bw = FALSE,
    pval_position = "bottom.right",
    xlab = "Age (Years)",
    ylab = "Predicted Geometric Mean SBP (mmHg)",
    legend_title = "BMI (Percentiles)"
  )
)

# --- Plot 2: Cleaner Plot (using SD and CIs) ---
# This shows the effect of Age at Mean +/- 1 SD of BMI
# We turn off CIs for a cleaner look if they are too wide
print(
  plotint(
    model = model_bp_interaction,
    effect = "Age",
    moderator = "BMI",
    data = nhanes_clean,
    mod_scale = "sd",             # Use Mean +/- 1 SD for BMI
    type = "response",
    show_ci = FALSE,            # Turn off CI ribbons
    bw = TRUE,                  # Use B&W linetypes
    pval_position = "bottom.right",
    xlab = "Age (Years)",
    ylab = "Predicted Geometric Mean SBP (mmHg)",
    legend_title = "BMI (Standard Deviations)"
  )
)
}
}
